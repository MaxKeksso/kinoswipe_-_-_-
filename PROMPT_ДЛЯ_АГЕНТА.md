# Промпт для агента: доработка проекта KinoSwipe

Используй этот документ как основной контекст. Проект уже работает автономно на сервере (Railway), но нужны улучшения по всем направлениям: фронтенд, бэкенд, алгоритмы, автономность.

---

## 1. О чём проект

**KinoSwipe** — веб-приложение для совместного выбора фильмов (механика свайпов, как в Tinder). Участники создают комнату, вместе свайпают карточки фильмов; когда все лайкают один фильм — происходит «матч», показываются ссылки на стриминги и т.д.

**Дополнительно:** страница «Футбол» с матчами РПЛ и Лиги Чемпионов (данные из API), админ-панель для премьер, профиль пользователя со статистикой.

**Деплой:** один сервис на Railway (Go backend + статика фронта из `web/`), отдельный сервис PostgreSQL. Сборка: монолит (backend собирает фронт в `web/`).

---

## 2. Стек и структура

### Backend (Go)
- **Роутер:** `gorilla/mux`
- **БД:** PostgreSQL, драйвер `lib/pq`, без ORM
- **Слои:** handlers → service → repository → models
- **Точка входа:** `cmd/server/main.go`
- **Конфиг:** `config/config.go` (env, в т.ч. `DATABASE_URL`, `FOOTBALL_API_KEY`, `MOVIE_API_KEY`, `JWT_SECRET`)
- **Миграции:** `migrations/` (golang-migrate), скрипты: `применить_миграции.sh`, `импорт_csv.sh`

Основные пакеты:
- `handlers/` — HTTP + WebSocket (комнаты, свайпы, матчи, премьеры, футбол, auth, users)
- `service/` — `match_service.go` (алгоритм матча), `football_service.go` (Football-Data.org + кеш)
- `repository/` — по одной сущности (user, room, movie, swipe, match, filter, feedback, premiere, match_link)
- `models/` — доменные структуры
- `middleware/` — CORS, logging, recovery

### Frontend (React + TypeScript)
- **Точка входа:** `frontend/src/index.tsx` → `App.tsx`
- **API:** `frontend/src/api/api.ts` — один объект `apiService` (именованный экспорт), не default
- **Состояние:** локальный state в `App.tsx`, нет Redux
- **Экраны/состояния:** auth, genre-questionnaire, room-selection, room-waiting, swiping, match, match-links, admin, football, profile, movie-library, recommendation

Компоненты:
- `AuthForm`, `SwipeCard`, `MatchLinksPage`, `AdminPanel`, `PremiereSidebar`, `Profile`, `MovieLibrary`, `FootballPage`, `RecommendationPage`, `MovieDetails`, `GenreQuestionnaire`

### База данных
- **users** — id, username, email, phone, password_hash, user_type (admin/user), created_at, updated_at
- **rooms** — id, code, host_id, status, filter_id
- **room_members** — room_id, user_id
- **movies** — id, title, poster_url, genre (может быть JSONB/массив), year, duration, imdb_rating, kp_rating и т.д.
- **swipes** — user_id, room_id, movie_id, direction (left/right), UNIQUE(user_id, room_id, movie_id)
- **matches** — room_id, movie_id, UNIQUE(room_id, movie_id)
- **filters** — привязка к комнате (жанры, годы и т.д.)
- **premieres** — title, poster_url, position (left/right), is_active
- **match_links** — match_id, platform, url, title
- **feedbacks** — по желанию

Миграции: `000001_initial_schema.*`, `000002_add_premieres_and_auth.*`.

---

## 3. Алгоритм матча (уже есть, можно улучшать)

- **Правило:** матч = один фильм, который **все** участники комнаты лайкнули (свайп вправо).
- **Место:** `service/match_service.go` → `CheckAndCreateMatch(roomID, movieID)`.
- Логика: по комнате получаем участников, по фильму — все свайпы вправо; если множество «лайкнувших» = множество участников → создаём матч (идемпотентно), пишем в БД, можно слать событие в WebSocket.
- **Идеи для улучшения:** учёт вышедших из комнаты, «почти матч» (N-1 лайков), приоритет по рейтингу/жанрам, ограничение числа матчей на комнату.

---

## 4. Что улучшать (общие направления)

### Backend
- Безопасность: JWT вместо только `X-User-ID`, проверка прав (админ/владелец комнаты).
- Валидация и лимиты: размер тела запроса, rate limiting, санитизация входов.
- Футбол: точное время матчей (часовой пояс Москвы уже учтён в `football_service`); при необходимости — второй источник (API-Football / api-sport и т.д.) для РПЛ и времени.
- Премьеры/контент: CRUD уже есть; при желании — мягкое удаление, версионирование.
- Матчи фильмов: ссылки на стриминги (`match_links`) — проверка URL, нормализация.
- Логирование: структурированные логи (JSON), уровни, request_id.
- Health: `/api/v1/health` с проверкой БД (и при необходимости внешних API).
- Фоновые задачи: пока без очередей; при необходимости — воркер для обновления постеров, кеша футбола и т.д.

### Frontend
- UX: загрузки, ошибки сети, повтор запроса; валидация форм (email, пароль, код комнаты).
- Адаптив: комнаты, свайпы, премьеры, футбол, админка — всё должно нормально смотреться на мобильных.
- Доступность: семантика, aria, фокус при модалках.
- Производительность: мемоизация тяжёлых списков, ленивая подгрузка фильмов при свайпе.
- Состояние: при росте логики рассмотреть контекст или лёгкий state (например, по комнате/матчам).

### Алгоритм и продукт
- Матч: см. выше; при желании — «рекомендация по жанрам» на основе анкеты и уже просмотренных.
- Комнаты: таймаут неактивных комнат, лимит участников, возможность «заморозить» комнату.
- Фильмы: пагинация/курсор при большом каталоге; кеш на бэкенде для частых запросов.

### Автономность на сервере
- Запуск одного бинарника: всё уже в одном процессе (API + раздача `web/`).
- Миграции: выполняются вручную или скриптом (`применить_миграции.sh`) с `DATABASE_URL`; при деплое на Railway — переменная из Reference к Postgres.
- Данные: импорт фильмов — `импорт_csv.sh`; постеры — при необходимости скрипт/команда с OMDb/другим API.
- Футбол: кеш в памяти на 5 минут, запросы к Football-Data.org; при падении API — fallback на статичные данные.
- Админ: создаётся скриптом (например `создать_админа_в_прод.sh`) в прод БД.

---

## 5. Важные файлы для первого обзора

- `README.md`, `ARCHITECTURE.md` — общее описание и слои.
- `cmd/server/main.go` — роуты и инициализация.
- `config/config.go` — переменные окружения.
- `service/match_service.go` — алгоритм матча.
- `service/football_service.go` — футбол, время (UTC → Moscow), кеш.
- `handlers/auth_handler.go`, `handlers/room_handler.go`, `handlers/swipe_handler.go` — ключевые сценарии.
- `frontend/src/App.tsx` — состояния и навигация.
- `frontend/src/api/api.ts` — все вызовы к API (именованный экспорт `apiService`).
- `migrations/` — актуальная схема БД.
- `RAILWAY_НАСТРОЙКА_БД.md`, `FOOTBALL_API_SETUP.md`, `RPL_API_INTEGRATION.md` — деплой и API.

---

## 6. Ограничения и соглашения

- Не ломать текущий деплой: один сервис на Railway, статика из `web/`, `DATABASE_URL` из Reference.
- Фронт импортирует API как `import { apiService, ... } from './api/api'` (не default).
- Сохранять поддержку русского языка в UI и сообщениях об ошибках.
- При добавлении полей в БД — только через миграции (up/down).

---

## 7. Задачи для агента (приоритеты можно менять)

1. **Алгоритм:** Улучшить или задокументировать логику матча; при желании добавить «почти матч» или приоритизацию.
2. **Безопасность:** Ввести JWT (логин/регистрация уже есть), убрать зависимость от одного только `X-User-ID` в критичных эндпоинтах.
3. **Футбол:** Проверить отображение времени (московское); при необходимости подключить второй API для РПЛ/точного времени.
4. **Фронт:** Улучшить обработку ошибок, загрузки и адаптив (комнаты, свайпы, футбол, админка).
5. **Автономность:** Проверить health check, логи, при необходимости — простой фоновый слой (обновление кеша/постеров без очередей).
6. **Код:** Рефакторинг дублирования, тесты для `MatchService` и критичных handlers.

Агент может разбить эти пункты на подзадачи и выполнять по шагам, опираясь на этот промпт и структуру репозитория.
