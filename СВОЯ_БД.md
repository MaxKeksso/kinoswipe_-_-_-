# Подключение своей PostgreSQL к KinoSwipe

Чтобы приложение и скрипты работали с **вашей** базой данных в PostgreSQL, сделайте следующее.

## 1. Создайте базу и пользователя (обязательно, если видите "role kinoswipe does not exist")

В вашем PostgreSQL по умолчанию нет пользователя `kinoswipe`. Его нужно создать **один раз** под суперпользователем.

**Способ А: выполнить готовый SQL-скрипт**

Из корня проекта (подставьте своего суперпользователя и порт, если не `postgres` и не 5432):

```bash
cd /Users/maksimzagorodnev/Downloads/kinoswipe
psql -h localhost -p 5432 -U postgres -f scripts/init_db.sql
```

Введите пароль суперпользователя `postgres`, когда попросит.

**Способ Б: вручную в psql**

```bash
psql -h localhost -p 5432 -U postgres
```

В psql выполните:

```sql
CREATE USER kinoswipe WITH PASSWORD 'kinoswipe123';
CREATE DATABASE kinoswipe OWNER kinoswipe;
GRANT ALL PRIVILEGES ON DATABASE kinoswipe TO kinoswipe;
\c kinoswipe
GRANT ALL ON SCHEMA public TO kinoswipe;
```

После этого миграции и приложение смогут подключаться как `kinoswipe`/`kinoswipe123` к базе `kinoswipe`.

Если хотите использовать **своего** пользователя и свою базу — создайте их так же, а в `DATABASE_URL` укажите своего пользователя, пароль и имя базы.

## 2. Примените миграции (создание таблиц)

Нужно один раз создать все таблицы в вашей БД.

### Вариант А: через golang-migrate (рекомендуется)

```bash
# Установка (Mac)
brew install golang-migrate

# Из корня проекта
cd /Users/maksimzagorodnev/Downloads/kinoswipe

# Подставьте свои: пользователь, пароль, хост, порт, имя базы
export DATABASE_URL="postgres://kinoswipe:kinoswipe123@localhost:5432/kinoswipe?sslmode=disable"

migrate -path ./migrations -database "$DATABASE_URL" up
```

### Вариант Б: вручную через psql

```bash
psql -h localhost -p 5432 -U kinoswipe -d kinoswipe -f migrations/000001_initial_schema.up.sql
psql -h localhost -p 5432 -U kinoswipe -d kinoswipe -f migrations/000002_add_premieres_and_auth.up.sql
```

Подставьте свой хост, порт, пользователя и базу, если они другие.

## 3. Настройте приложение на вашу БД

В **корне проекта** создайте файл `.env` (скопируйте из примера):

```bash
cp .env.example .env
```

Откройте `.env` и укажите строку подключения к вашей БД:

```env
DATABASE_URL=postgres://ВАШ_ПОЛЬЗОВАТЕЛЬ:ВАШ_ПАРОЛЬ@localhost:5432/ВАША_БАЗА?sslmode=disable
```

Пример для пользователя `kinoswipe`, пароля `kinoswipe123`, базы `kinoswipe` на порту 5432:

```env
DATABASE_URL=postgres://kinoswipe:kinoswipe123@localhost:5432/kinoswipe?sslmode=disable
```

После этого:

- **Приложение** (при запуске из корня проекта) будет читать `.env` и подключаться к этой БД.
- **Скрипты** `createadmin` и `loadmovies` тоже подхватят `DATABASE_URL` из `.env`, если запускать их из корня проекта.

## 4. Запуск приложения с вашей БД

### Без Docker (только backend и ваша PostgreSQL)

```bash
cd /Users/maksimzagorodnev/Downloads/kinoswipe
# .env уже с DATABASE_URL
go run cmd/server/main.go
```

Приложение подключится к БД из `DATABASE_URL`.

### С Docker (приложение в контейнере, БД — ваша на хосте)

Передайте в контейнер вашу строку подключения. В `docker-compose.yml` у сервиса `app` в `environment` добавьте (или замените существующие переменные БД):

```yaml
app:
  environment:
    DATABASE_URL: postgres://kinoswipe:kinoswipe123@host.docker.internal:5432/kinoswipe?sslmode=disable
    # остальные переменные...
```

`host.docker.internal` — это хост-машина с Mac/Windows, где крутится ваша PostgreSQL. Если БД на другом сервере, укажите его адрес.

Либо создайте `.env` в корне и в `docker-compose.yml` добавьте:

```yaml
app:
  env_file: .env
```

и в `.env` задайте `DATABASE_URL` с хостом, доступным из контейнера (например, `host.docker.internal` или IP машины с PostgreSQL).

## 5. Скрипты (админ, загрузка фильмов)

Из корня проекта:

```bash
cd /Users/maksimzagorodnev/Downloads/kinoswipe
# Используется DATABASE_URL из .env
go run -tags createadmin ./scripts/
go run -tags loadmovies ./scripts/
```

Создание админа и загрузка фильмов пойдут в ту же БД, что указана в `.env`.

## 6. Итог

| Что              | Откуда берёт подключение |
|------------------|---------------------------|
| Backend (Go)     | `.env` → `DATABASE_URL` или `DB_*` |
| Скрипты         | `.env` → `DATABASE_URL` (при запуске из корня) |
| Миграции         | Переменная `DATABASE_URL` в терминале или вручную через `psql` |

Один раз настроили `.env` и применили миграции — дальше и приложение, и скрипты работают с вашей PostgreSQL, и вы можете управлять данными в ней как обычно.
