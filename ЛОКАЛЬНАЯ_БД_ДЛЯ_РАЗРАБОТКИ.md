# Локальная БД для разработки

Чтобы у каждого разработчика была своя база PostgreSQL (пользователи, фильмы, комнаты, пароли и т.д.) и всё работало локально без Railway.

---

## Где смотреть таблицы в pgAdmin (терминал говорит «таблицы созданы», но в pgAdmin их не видно)

Скрипт миграций подключается к **одной** базе (хост + порт + имя БД), а в pgAdmin ты можешь быть подключён к **другой**. Таблицы появятся только в той БД, к которой реально подключался скрипт.

**Что сделать:**

1. **Узнать, куда подключался скрипт.** При запуске `./применить_миграции.sh` теперь выводится строка вида:
   - `Подключение: postgres://kinoswipe:***@localhost:5433/kinoswipe?...` — значит БД в **Docker, порт 5433**.
   - `Подключение: postgres://maksimzagorodnev:***@localhost:5432/kinoswipe?...` — значит твоя локальная PostgreSQL, **порт 5432**.

2. **В pgAdmin открыть ту же самую базу:**
   - Если скрипт использовал **Docker (порт 5433)** — в pgAdmin нужно подключиться к серверу с хостом `localhost` и портом **5433**, БД `kinoswipe`, пользователь `kinoswipe`, пароль `kinoswipe123`. Если у тебя сервер `newserv` с портом 5432 — это **другая** база; создай новый сервер (Register → Server) с портом 5433 и зайди в базу `kinoswipe` там.
   - Если скрипт использовал **твою PostgreSQL (порт 5432)** — смотри базу `kinoswipe` на сервере, где порт 5432 (например, `newserv`).

3. **Обновить список таблиц:** в дереве слева правый клик по **Tables** (или по базе `kinoswipe`) → **Refresh**. Должны появиться **users**, **rooms**, **movies**, **swipes**, **matches**, **premieres**, **match_links** и т.д.

4. **Проверить через SQL:** открой Query Tool и выполни:
   ```sql
   SELECT table_name FROM information_schema.tables WHERE table_schema = 'public' ORDER BY table_name;
   ```
   Список покажет все таблицы в текущей базе.

---

## В pgAdmin видна только таблица schema_migrations — что делать?

Это значит, что миграции ещё не применены (или применены не все). Нужно один раз выполнить миграции — после этого появятся все таблицы: **users**, **rooms**, **movies**, **swipes**, **matches**, **premieres**, **match_links** и т.д.

**Вариант 1 — скрипт (если есть .env с DATABASE_URL):**
```bash
cd /Users/maksimzagorodnev/Downloads/kinoswipe
chmod +x применить_миграции.sh
./применить_миграции.sh
```

**Вариант 2 — вручную.** В терминале выполни (подставь **свои** данные подключения из pgAdmin: пользователь, пароль, хост, порт, имя БД):
```bash
cd /Users/maksimzagorodnev/Downloads/kinoswipe
migrate -path ./migrations -database "postgres://ТВОЙ_ПОЛЬЗОВАТЕЛЬ:ТВОЙ_ПАРОЛЬ@localhost:5432/kinoswipe?sslmode=disable" up
```
Пример: если в pgAdmin сервер `newserv`, пользователь `maksimzagorodnev`, пароль `mypass`, БД `kinoswipe`, порт 5432:
```bash
migrate -path ./migrations -database "postgres://maksimzagorodnev:mypass@localhost:5432/kinoswipe?sslmode=disable" up
```

После успешного выполнения в pgAdmin обнови список таблиц (правый клик по Tables → Refresh) — появятся **users**, **rooms**, **movies** и остальные. Дальше можно смотреть и править данные через pgAdmin как обычно.

---

## За одну минуту (с нуля)

```bash
# 1. Клонировать проект
git clone https://github.com/MaxKeksso/kinoswipe_-_-_-.git
cd kinoswipe_-_-_-

# 2. Поднять только PostgreSQL (из docker-compose)
docker-compose up -d postgres

# 3. Настроить .env
cp .env.example .env
# В .env уже прописано: DATABASE_URL=postgres://kinoswipe:kinoswipe123@localhost:5433/kinoswipe?sslmode=disable

# 4. Создать таблицы (миграции)
brew install golang-migrate   # или скачать с https://github.com/golang-migrate/migrate/releases
migrate -path ./migrations -database "$(grep DATABASE_URL .env | cut -d= -f2)" up

# 5. Запустить бэкенд и фронт
# Бэкенд:
go run ./cmd/server
# В другом терминале — фронт:
cd frontend && npm install && npm start
```

Открой http://localhost:3000 — приложение работает с локальной БД. Данные (пользователи, фильмы, комнаты) хранятся в контейнере `kinoswipe_db`.

---

## Что где

| Где       | База данных                    | Когда использовать        |
|----------|---------------------------------|----------------------------|
| Railway  | PostgreSQL в облаке Railway    | Прод: общий доступ по ссылке |
| Локально | PostgreSQL в Docker (порт 5433) | Разработка у себя на компе   |

В коде ничего переключать не нужно: если задан `DATABASE_URL` в `.env` (локально) — приложение подключается к локальной БД; на Railway подставляется переменная из Variables.

---

## Полезные команды

- **Только поднять БД:** `docker-compose up -d postgres`
- **Остановить БД:** `docker-compose stop postgres`
- **Миграции вверх:** `migrate -path ./migrations -database "postgres://kinoswipe:kinoswipe123@localhost:5433/kinoswipe?sslmode=disable" up`
- **Миграции вниз (откат):** `migrate -path ./migrations -database "postgres://kinoswipe:kinoswipe123@localhost:5433/kinoswipe?sslmode=disable" down 1`
- **Подключиться к БД вручную:**  
  `psql "postgres://kinoswipe:kinoswipe123@localhost:5433/kinoswipe"`  
  или через GUI (DBeaver, pgAdmin), хост `localhost`, порт **5433**, пользователь `kinoswipe`, пароль `kinoswipe123`, БД `kinoswipe`.

---

## Добавление данных (фильмы, админ)

- **Через приложение:** зайди как админ (см. скрипт создания админа в `scripts/`) — откроется админ-панель, там можно добавлять фильмы и премьеры.
- **Импорт из CSV (IMDB Top 1000):** положи в корень проекта файл `imdb_top_1000.csv`, в `.env` задай `DATABASE_URL`, затем выполни:
  ```bash
  chmod +x импорт_csv.sh
  ./импорт_csv.sh
  ```
  Или вручную: `go run ./cmd/import_csv imdb_top_1000.csv`. Колонки CSV: Series_Title, Released_Year, IMDB_Rating, Genre, Runtime, Overview, Poster_Link — маппятся в таблицу `movies`.
- **Через скрипты:** см. `scripts/README.md` (например, загрузка фильмов).
- **Напрямую в БД:** через `psql` или GUI — таблицы `users`, `movies`, `rooms`, `premieres` и т.д. после миграций уже созданы.

После любых изменений в миграциях запускай `migrate ... up` заново; данные в БД при этом не теряются (миграции добавляют новое, не пересоздают уже созданные таблицы без down).
